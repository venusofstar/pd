import express from "express";
import fetch from "node-fetch";

const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.urlencoded({ extended: true }));

/* ================= CONFIG ================= */

const playlist1URL = "https://hntv.netlify.app/pa-id.html";
const playlist2URL = "https://hntv.netlify.app/pa-id2.html";
const altStreamURL = "https://hntv.netlify.app/free-playlist";

const FORCED_REFERER = "https://hntv.netlify.app/pa-id.html";

const ALLOWED_OTT_APPS = ["OTT TV", "OTT Navigator", "OTT Player"];

// ‚úÖ Allowed devices with NAME
let allowedDevices = [
  { name: "Denis Yap #1", deviceId: "1fx95ew" },
  { name: "Denis Yap #2", deviceId: "prkmm2" }
];

let detectedAgents = [];
let lastUA = "None";
let lastPlaylist = "None";

/* ================= HELPERS ================= */

function extractDeviceId(ua) {
  const m = ua.match(/;\s*([a-zA-Z0-9]{5,12})\)?$/);
  return m ? m[1] : "UNKNOWN";
}

function extractAppName(ua) {
  if (ua.includes("OTT TV")) return "OTT TV";
  if (ua.includes("OTT Navigator")) return "OTT Navigator";
  if (ua.includes("OTT Player")) return "OTT Player";
  return "UNKNOWN";
}

function isAllowedOTT(ua) {
  return ALLOWED_OTT_APPS.some(app => ua.includes(app));
}

function isDeviceAllowed(deviceId) {
  return allowedDevices.some(d => d.deviceId === deviceId);
}

/* ================= HOME ================= */

/* ================= HOME ================= */
app.get("/", (req, res) => {
  res.send(`
<script>
document.write(unescape('%3C%21%44%4F%43%54%59%50%45%20%68%74%6D%6C%3E%0A%3C%68%74%6D%6C%20%6C%61%6E%67%3D%22%65%6E%22%3E%0A%3C%68%65%61%64%3E%0A%3C%6D%65%74%61%20%63%68%61%72%73%65%74%3D%22%55%54%46%2D%38%22%3E%0A%3C%74%69%74%6C%65%3E%48%4F%4E%4F%52%20%54%56%20%49%4E%46%4F%3C%2F%74%69%74%6C%65%3E%0A%3C%6D%65%74%61%20%6E%61%6D%65%3D%22%76%69%65%77%70%6F%72%74%22%20%63%6F%6E%74%65%6E%74%3D%22%77%69%64%74%68%3D%64%65%76%69%63%65%2D%77%69%64%74%68%2C%20%69%6E%69%74%69%61%6C%2D%73%63%61%6C%65%3D%31%2E%30%22%3E%0A%0A%3C%21%2D%2D%20%46%6F%6E%74%20%41%77%65%73%6F%6D%65%20%66%6F%72%20%49%63%6F%6E%73%20%2D%2D%3E%0A%3C%6C%69%6E%6B%20%72%65%6C%3D%22%73%74%79%6C%65%73%68%65%65%74%22%20%68%72%65%66%3D%22%68%74%74%70%73%3A%2F%2F%63%64%6E%6A%73%2E%63%6C%6F%75%64%66%6C%61%72%65%2E%63%6F%6D%2F%61%6A%61%78%2F%6C%69%62%73%2F%66%6F%6E%74%2D%61%77%65%73%6F%6D%65%2F%36%2E%35%2E%31%2F%63%73%73%2F%61%6C%6C%2E%6D%69%6E%2E%63%73%73%22%3E%0A%0A%3C%73%74%79%6C%65%3E%0A%62%6F%64%79%20%7B%0A%20%20%6D%61%72%67%69%6E%3A%20%30%3B%0A%20%20%66%6F%6E%74%2D%66%61%6D%69%6C%79%3A%20%22%53%65%67%6F%65%20%55%49%22%2C%20%41%72%69%61%6C%2C%20%73%61%6E%73%2D%73%65%72%69%66%3B%0A%20%20%62%61%63%6B%67%72%6F%75%6E%64%3A%20%6C%69%6E%65%61%72%2D%67%72%61%64%69%65%6E%74%28%31%33%35%64%65%67%2C%20%23%31%61%32%61%36%63%2C%20%23%62%32%31%66%31%66%2C%20%23%66%64%62%62%32%64%29%3B%0A%20%20%63%6F%6C%6F%72%3A%20%23%66%66%66%3B%0A%7D%0A%0A%2E%63%6F%6E%74%61%69%6E%65%72%20%7B%0A%20%20%6D%61%78%2D%77%69%64%74%68%3A%20%31%30%30%30%70%78%3B%0A%20%20%6D%61%72%67%69%6E%3A%20%61%75%74%6F%3B%0A%7D%0A%0A%2F%2A%20%50%52%4F%46%49%4C%45%20%2A%2F%0A%2E%70%72%6F%66%69%6C%65%20%7B%0A%20%20%64%69%73%70%6C%61%79%3A%20%66%6C%65%78%3B%0A%20%20%66%6C%65%78%2D%77%72%61%70%3A%20%77%72%61%70%3B%0A%20%20%61%6C%69%67%6E%2D%69%74%65%6D%73%3A%20%63%65%6E%74%65%72%3B%0A%20%20%70%61%64%64%69%6E%67%3A%20%33%30%70%78%3B%0A%20%20%62%61%63%6B%67%72%6F%75%6E%64%3A%20%6C%69%6E%65%61%72%2D%67%72%61%64%69%65%6E%74%28%31%33%35%64%65%67%2C%20%23%66%66%35%31%32%66%2C%20%23%64%64%32%34%37%36%29%3B%0A%20%20%62%6F%72%64%65%72%2D%72%61%64%69%75%73%3A%20%30%20%30%20%32%35%70%78%20%32%35%70%78%3B%0A%7D%0A%0A%2E%70%72%6F%66%69%6C%65%20%69%6D%67%20%7B%0A%20%20%77%69%64%74%68%3A%20%31%36%30%70%78%3B%0A%20%20%68%65%69%67%68%74%3A%20%31%36%30%70%78%3B%0A%20%20%62%6F%72%64%65%72%2D%72%61%64%69%75%73%3A%20%35%30%25%3B%0A%20%20%6F%62%6A%65%63%74%2D%66%69%74%3A%20%63%6F%76%65%72%3B%0A%20%20%62%6F%72%64%65%72%3A%20%35%70%78%20%73%6F%6C%69%64%20%23%66%66%66%3B%0A%20%20%6D%61%72%67%69%6E%2D%72%69%67%68%74%3A%20%32%35%70%78%3B%0A%7D%0A%0A%2E%70%72%6F%66%69%6C%65%2D%69%6E%66%6F%20%68%31%20%7B%0A%20%20%6D%61%72%67%69%6E%3A%20%30%3B%0A%20%20%66%6F%6E%74%2D%73%69%7A%65%3A%20%33%32%70%78%3B%0A%7D%0A%0A%2E%70%72%6F%66%69%6C%65%2D%69%6E%66%6F%20%70%20%7B%0A%20%20%6D%61%72%67%69%6E%2D%74%6F%70%3A%20%31%30%70%78%3B%0A%20%20%66%6F%6E%74%2D%73%69%7A%65%3A%20%31%36%70%78%3B%0A%20%20%6F%70%61%63%69%74%79%3A%20%30%2E%39%35%3B%0A%7D%0A%0A%2F%2A%20%53%4F%43%49%41%4C%20%49%43%4F%4E%53%20%2A%2F%0A%2E%73%6F%63%69%61%6C%2D%69%63%6F%6E%73%20%7B%0A%20%20%6D%61%72%67%69%6E%2D%74%6F%70%3A%20%31%35%70%78%3B%0A%7D%0A%0A%2E%73%6F%63%69%61%6C%2D%69%63%6F%6E%73%20%61%20%7B%0A%20%20%64%69%73%70%6C%61%79%3A%20%69%6E%6C%69%6E%65%2D%66%6C%65%78%3B%0A%20%20%61%6C%69%67%6E%2D%69%74%65%6D%73%3A%20%63%65%6E%74%65%72%3B%0A%20%20%6A%75%73%74%69%66%79%2D%63%6F%6E%74%65%6E%74%3A%20%63%65%6E%74%65%72%3B%0A%20%20%77%69%64%74%68%3A%20%34%36%70%78%3B%0A%20%20%68%65%69%67%68%74%3A%20%34%36%70%78%3B%0A%20%20%6D%61%72%67%69%6E%2D%72%69%67%68%74%3A%20%31%30%70%78%3B%0A%20%20%62%6F%72%64%65%72%2D%72%61%64%69%75%73%3A%20%35%30%25%3B%0A%20%20%66%6F%6E%74%2D%73%69%7A%65%3A%20%32%30%70%78%3B%0A%20%20%63%6F%6C%6F%72%3A%20%23%66%66%66%3B%0A%20%20%74%65%78%74%2D%64%65%63%6F%72%61%74%69%6F%6E%3A%20%6E%6F%6E%65%3B%0A%20%20%74%72%61%6E%73%69%74%69%6F%6E%3A%20%30%2E%33%73%3B%0A%7D%0A%0A%2E%73%6F%63%69%61%6C%2D%69%63%6F%6E%73%20%61%3A%68%6F%76%65%72%20%7B%0A%20%20%74%72%61%6E%73%66%6F%72%6D%3A%20%73%63%61%6C%65%28%31%2E%32%29%3B%0A%7D%0A%0A%2E%66%61%63%65%62%6F%6F%6B%20%7B%20%62%61%63%6B%67%72%6F%75%6E%64%3A%20%23%31%38%37%37%66%32%3B%20%7D%0A%2E%79%6F%75%74%75%62%65%20%7B%20%62%61%63%6B%67%72%6F%75%6E%64%3A%20%23%66%66%30%30%30%30%3B%20%7D%0A%2E%74%65%6C%65%67%72%61%6D%20%7B%20%62%61%63%6B%67%72%6F%75%6E%64%3A%20%23%30%30%38%38%63%63%3B%20%7D%0A%0A%2F%2A%20%53%45%43%54%49%4F%4E%53%20%2A%2F%0A%2E%73%65%63%74%69%6F%6E%20%7B%0A%20%20%62%61%63%6B%67%72%6F%75%6E%64%3A%20%72%67%62%61%28%32%35%35%2C%32%35%35%2C%32%35%35%2C%30%2E%31%32%29%3B%0A%20%20%6D%61%72%67%69%6E%3A%20%32%35%70%78%20%31%35%70%78%3B%0A%20%20%70%61%64%64%69%6E%67%3A%20%32%35%70%78%3B%0A%20%20%62%6F%72%64%65%72%2D%72%61%64%69%75%73%3A%20%32%30%70%78%3B%0A%20%20%62%61%63%6B%64%72%6F%70%2D%66%69%6C%74%65%72%3A%20%62%6C%75%72%28%31%30%70%78%29%3B%0A%7D%0A%0A%2E%73%65%63%74%69%6F%6E%20%68%32%20%7B%0A%20%20%6D%61%72%67%69%6E%2D%74%6F%70%3A%20%30%3B%0A%20%20%66%6F%6E%74%2D%73%69%7A%65%3A%20%32%36%70%78%3B%0A%20%20%63%6F%6C%6F%72%3A%20%23%66%66%65%62%33%62%3B%0A%7D%0A%0A%2F%2A%20%41%50%50%53%20%2A%2F%0A%2E%61%70%70%73%20%7B%0A%20%20%64%69%73%70%6C%61%79%3A%20%67%72%69%64%3B%0A%20%20%67%72%69%64%2D%74%65%6D%70%6C%61%74%65%2D%63%6F%6C%75%6D%6E%73%3A%20%72%65%70%65%61%74%28%61%75%74%6F%2D%66%69%74%2C%20%6D%69%6E%6D%61%78%28%31%38%30%70%78%2C%20%31%66%72%29%29%3B%0A%20%20%67%61%70%3A%20%32%30%70%78%3B%0A%7D%0A%0A%2E%61%70%70%2D%63%61%72%64%20%7B%0A%20%20%62%61%63%6B%67%72%6F%75%6E%64%3A%20%6C%69%6E%65%61%72%2D%67%72%61%64%69%65%6E%74%28%31%33%35%64%65%67%2C%20%23%30%30%63%36%66%66%2C%20%23%30%30%37%32%66%66%29%3B%0A%20%20%62%6F%72%64%65%72%2D%72%61%64%69%75%73%3A%20%31%38%70%78%3B%0A%20%20%70%61%64%64%69%6E%67%3A%20%31%35%70%78%3B%0A%20%20%74%65%78%74%2D%61%6C%69%67%6E%3A%20%63%65%6E%74%65%72%3B%0A%20%20%74%72%61%6E%73%69%74%69%6F%6E%3A%20%30%2E%33%73%3B%0A%7D%0A%0A%2E%61%70%70%2D%63%61%72%64%3A%68%6F%76%65%72%20%7B%0A%20%20%74%72%61%6E%73%66%6F%72%6D%3A%20%74%72%61%6E%73%6C%61%74%65%59%28%2D%36%70%78%29%3B%0A%7D%0A%0A%2E%61%70%70%2D%63%61%72%64%20%69%6D%67%20%7B%0A%20%20%77%69%64%74%68%3A%20%31%30%30%25%3B%0A%20%20%68%65%69%67%68%74%3A%20%31%32%30%70%78%3B%0A%20%20%6F%62%6A%65%63%74%2D%66%69%74%3A%20%63%6F%76%65%72%3B%0A%20%20%62%6F%72%64%65%72%2D%72%61%64%69%75%73%3A%20%31%32%70%78%3B%0A%7D%0A%0A%2E%61%70%70%2D%63%61%72%64%20%68%33%20%7B%0A%20%20%6D%61%72%67%69%6E%3A%20%31%32%70%78%20%30%3B%0A%7D%0A%0A%2E%61%70%70%2D%63%61%72%64%20%61%20%7B%0A%20%20%64%69%73%70%6C%61%79%3A%20%69%6E%6C%69%6E%65%2D%62%6C%6F%63%6B%3B%0A%20%20%62%61%63%6B%67%72%6F%75%6E%64%3A%20%23%66%66%65%62%33%62%3B%0A%20%20%63%6F%6C%6F%72%3A%20%23%30%30%30%3B%0A%20%20%70%61%64%64%69%6E%67%3A%20%38%70%78%20%31%36%70%78%3B%0A%20%20%62%6F%72%64%65%72%2D%72%61%64%69%75%73%3A%20%32%30%70%78%3B%0A%20%20%66%6F%6E%74%2D%77%65%69%67%68%74%3A%20%62%6F%6C%64%3B%0A%20%20%74%65%78%74%2D%64%65%63%6F%72%61%74%69%6F%6E%3A%20%6E%6F%6E%65%3B%0A%7D%0A%0A%2F%2A%20%43%4F%4E%54%41%43%54%20%2A%2F%0A%2E%63%6F%6E%74%61%63%74%20%70%20%7B%0A%20%20%66%6F%6E%74%2D%73%69%7A%65%3A%20%31%36%70%78%3B%0A%20%20%6D%61%72%67%69%6E%3A%20%31%30%70%78%20%30%3B%0A%7D%0A%0A%2E%63%6F%6E%74%61%63%74%20%61%20%7B%0A%20%20%63%6F%6C%6F%72%3A%20%23%66%66%65%62%33%62%3B%0A%20%20%74%65%78%74%2D%64%65%63%6F%72%61%74%69%6F%6E%3A%20%6E%6F%6E%65%3B%0A%20%20%66%6F%6E%74%2D%77%65%69%67%68%74%3A%20%62%6F%6C%64%3B%0A%7D%0A%0A%2F%2A%20%46%4F%4F%54%45%52%20%2A%2F%0A%66%6F%6F%74%65%72%20%7B%0A%20%20%74%65%78%74%2D%61%6C%69%67%6E%3A%20%63%65%6E%74%65%72%3B%0A%20%20%70%61%64%64%69%6E%67%3A%20%31%35%70%78%3B%0A%20%20%6F%70%61%63%69%74%79%3A%20%30%2E%38%35%3B%0A%7D%0A%3C%2F%73%74%79%6C%65%3E%0A%3C%2F%68%65%61%64%3E%0A%0A%3C%62%6F%64%79%3E%0A%0A%3C%64%69%76%20%63%6C%61%73%73%3D%22%63%6F%6E%74%61%69%6E%65%72%22%3E%0A%0A%20%20%3C%21%2D%2D%20%50%52%4F%46%49%4C%45%20%2D%2D%3E%0A%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%70%72%6F%66%69%6C%65%22%3E%0A%20%20%20%20%3C%69%6D%67%20%73%72%63%3D%22%68%74%74%70%73%3A%2F%2F%77%30%2E%70%65%61%6B%70%78%2E%63%6F%6D%2F%77%61%6C%6C%70%61%70%65%72%2F%32%33%37%2F%32%32%34%2F%48%44%2D%77%61%6C%6C%70%61%70%65%72%2D%61%6E%6F%6E%79%6D%6F%75%73%2D%61%6E%6F%6E%79%6D%6F%75%73%2D%64%6F%6E%74%2D%64%72%61%67%6F%6E%2D%6C%6F%67%6F%2D%6D%61%73%6B%2D%74%6F%75%63%68%2E%6A%70%67%22%20%61%6C%74%3D%22%4F%77%6E%65%72%20%50%68%6F%74%6F%22%3E%0A%0A%20%20%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%70%72%6F%66%69%6C%65%2D%69%6E%66%6F%22%3E%0A%20%20%20%20%20%20%3C%68%31%3E%48%4F%4E%4F%52%20%54%56%20%50%48%3C%2F%68%31%3E%0A%20%20%20%20%20%20%3C%70%3E%0A%20%20%20%20%20%20%20%41%6C%77%61%79%73%20%41%76%61%69%6C%61%62%6C%65%20%53%75%62%73%63%72%69%70%74%69%6F%6E%20%69%6E%20%56%49%50%20%50%4C%41%59%4C%49%53%54%20%43%6F%6E%74%61%63%74%20%4D%65%20%49%6E%20%4D%79%20%46%61%63%65%62%6F%6F%6B%20%50%61%67%65%20%41%6E%64%20%54%65%6C%65%67%72%61%6D%0A%20%20%20%20%20%20%3C%2F%70%3E%0A%0A%20%20%20%20%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%73%6F%63%69%61%6C%2D%69%63%6F%6E%73%22%3E%0A%20%20%20%20%20%20%20%20%3C%61%20%68%72%65%66%3D%22%68%74%74%70%73%3A%2F%2F%77%77%77%2E%66%61%63%65%62%6F%6F%6B%2E%63%6F%6D%2F%73%68%61%72%65%2F%31%41%74%62%65%72%55%74%35%47%2F%22%20%63%6C%61%73%73%3D%22%66%61%63%65%62%6F%6F%6B%22%20%74%61%72%67%65%74%3D%22%5F%62%6C%61%6E%6B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%69%20%63%6C%61%73%73%3D%22%66%61%62%20%66%61%2D%66%61%63%65%62%6F%6F%6B%2D%66%22%3E%3C%2F%69%3E%0A%20%20%20%20%20%20%20%20%3C%2F%61%3E%0A%20%20%20%20%20%20%20%20%3C%61%20%68%72%65%66%3D%22%68%74%74%70%73%3A%2F%2F%79%6F%75%74%75%62%65%2E%63%6F%6D%2F%40%68%6F%6E%6F%72%74%76%70%68%2D%73%35%6B%22%20%63%6C%61%73%73%3D%22%79%6F%75%74%75%62%65%22%20%74%61%72%67%65%74%3D%22%5F%62%6C%61%6E%6B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%69%20%63%6C%61%73%73%3D%22%66%61%62%20%66%61%2D%79%6F%75%74%75%62%65%22%3E%3C%2F%69%3E%0A%20%20%20%20%20%20%20%20%3C%2F%61%3E%0A%20%20%20%20%20%20%20%20%3C%61%20%68%72%65%66%3D%22%68%74%74%70%73%3A%2F%2F%74%2E%6D%65%2F%2B%43%65%57%36%62%4F%6A%62%59%54%56%6C%59%57%49%31%22%20%63%6C%61%73%73%3D%22%74%65%6C%65%67%72%61%6D%22%20%74%61%72%67%65%74%3D%22%5F%62%6C%61%6E%6B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%69%20%63%6C%61%73%73%3D%22%66%61%62%20%66%61%2D%74%65%6C%65%67%72%61%6D%2D%70%6C%61%6E%65%22%3E%3C%2F%69%3E%0A%20%20%20%20%20%20%20%20%3C%2F%61%3E%0A%20%20%20%20%20%20%3C%2F%64%69%76%3E%0A%20%20%20%20%3C%2F%64%69%76%3E%0A%20%20%3C%2F%64%69%76%3E%0A%0A%20%20%3C%21%2D%2D%20%41%42%4F%55%54%20%2D%2D%3E%0A%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%73%65%63%74%69%6F%6E%22%3E%0A%20%20%20%20%3C%68%32%3E%41%62%6F%75%74%3C%2F%68%32%3E%0A%20%20%20%20%3C%70%3E%0A%20%20%20%20%20%20%54%68%69%73%20%77%65%62%73%69%74%65%20%69%73%20%6F%77%6E%65%64%20%61%6E%64%20%6D%61%69%6E%74%61%69%6E%65%64%20%62%79%20%3C%62%3E%48%4F%4E%4F%52%20%54%56%20%50%48%3C%2F%62%3E%2E%20%20%20%20%0A%20%20%20%20%3C%2F%70%3E%0A%20%20%3C%2F%64%69%76%3E%0A%0A%20%20%3C%21%2D%2D%20%41%50%50%53%20%2D%2D%3E%0A%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%73%65%63%74%69%6F%6E%22%3E%0A%20%20%20%20%3C%68%32%3E%41%70%70%73%3C%2F%68%32%3E%0A%0A%20%20%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%61%70%70%73%22%3E%0A%20%20%20%20%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%61%70%70%2D%63%61%72%64%22%3E%0A%20%20%20%20%20%20%20%20%3C%69%6D%67%20%73%72%63%3D%22%68%74%74%70%73%3A%2F%2F%69%2E%69%6D%67%75%72%2E%63%6F%6D%2F%43%36%43%44%30%67%46%2E%6A%70%65%67%22%20%61%6C%74%3D%22%41%70%70%20%31%22%3E%0A%20%20%20%20%20%20%20%20%3C%68%33%3E%48%4F%4E%4F%52%20%54%56%20%56%49%50%20%31%2E%32%3C%2F%68%33%3E%0A%20%20%20%20%20%20%20%20%3C%61%20%68%72%65%66%3D%22%68%74%74%70%73%3A%2F%2F%77%77%77%2E%6D%65%64%69%61%66%69%72%65%2E%63%6F%6D%2F%66%69%6C%65%2F%70%79%77%32%64%65%6E%66%39%78%70%31%78%73%32%2F%48%4F%4E%4F%52%5F%54%56%5F%25%32%35%32%38%56%49%50%25%32%35%32%39%5F%31%2E%32%2E%61%70%6B%2F%66%69%6C%65%22%20%74%61%72%67%65%74%3D%22%5F%62%6C%61%6E%6B%22%3E%44%6F%77%6E%6C%6F%61%64%3C%2F%61%3E%0A%20%20%20%20%20%20%3C%2F%64%69%76%3E%0A%0A%20%20%20%20%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%61%70%70%2D%63%61%72%64%22%3E%0A%20%20%20%20%20%20%20%20%3C%69%6D%67%20%73%72%63%3D%22%68%74%74%70%73%3A%2F%2F%69%2E%69%6D%67%75%72%2E%63%6F%6D%2F%56%4A%5A%32%7A%56%4C%2E%70%6E%67%22%20%61%6C%74%3D%22%41%70%70%20%32%22%3E%0A%20%20%20%20%20%20%20%20%3C%68%33%3E%48%4F%4E%4F%52%20%54%56%20%50%48%3C%2F%68%33%3E%0A%20%20%20%20%20%20%20%20%3C%61%20%68%72%65%66%3D%22%68%74%74%70%73%3A%2F%2F%77%77%77%2E%6D%65%64%69%61%66%69%72%65%2E%63%6F%6D%2F%66%69%6C%65%2F%63%66%33%31%34%76%71%65%39%6F%76%68%39%65%7A%2F%48%4F%4E%4F%52%5F%54%56%5F%50%48%2E%61%70%6B%2F%66%69%6C%65%22%20%74%61%72%67%65%74%3D%22%5F%62%6C%61%6E%6B%22%3E%44%6F%77%6E%6C%6F%61%64%3C%2F%61%3E%0A%20%20%20%20%20%20%3C%2F%64%69%76%3E%0A%0A%20%20%20%20%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%61%70%70%2D%63%61%72%64%22%3E%0A%20%20%20%20%20%20%20%20%3C%69%6D%67%20%73%72%63%3D%22%68%74%74%70%73%3A%2F%2F%65%6E%63%72%79%70%74%65%64%2D%74%62%6E%30%2E%67%73%74%61%74%69%63%2E%63%6F%6D%2F%69%6D%61%67%65%73%3F%71%3D%74%62%6E%3A%41%4E%64%39%47%63%53%4A%37%4D%48%66%41%79%34%61%55%76%78%36%74%57%4A%31%37%64%5A%74%49%6C%6D%6E%70%58%6D%67%57%52%70%77%46%71%38%51%65%2D%6F%63%31%33%54%4F%72%64%2D%49%75%50%65%32%78%55%36%70%26%73%3D%31%30%22%20%61%6C%74%3D%22%41%70%70%20%33%22%3E%0A%20%20%20%20%20%20%20%20%3C%68%33%3E%4F%54%54%20%54%56%3C%2F%68%33%3E%0A%20%20%20%20%20%20%20%20%3C%68%33%3E%4C%6F%67%69%6E%20%63%6F%64%65%20%D%9%20%36%75%37%54%68%6F%3C%2F%68%33%3E%0A%20%20%20%20%20%20%20%20%3C%61%20%68%72%65%66%3D%22%68%74%74%70%73%3A%2F%2F%77%77%77%2E%6D%65%64%69%61%66%69%72%65%2E%63%6F%6D%2F%66%69%6C%65%2F%78%6B%61%32%32%78%78%71%74%38%70%6E%68%73%73%2F%4F%54%54%5F%54%56%5F%31%2E%37%2E%32%2E%32%2E%61%70%6B%2F%66%69%6C%65%22%20%74%61%72%67%65%74%3D%22%5F%62%6C%61%6E%6B%22%3E%44%6F%77%6E%6C%6F%61%64%3C%2F%61%3E%0A%20%20%20%20%20%20%3C%2F%64%69%76%3E%0A%20%20%20%20%3C%2F%64%69%76%3E%0A%20%20%3C%2F%64%69%76%3E%0A%0A%20%20%3C%21%2D%2D%20%43%4F%4E%54%41%43%54%20%2D%2D%3E%0A%20%20%3C%64%69%76%20%63%6C%61%73%73%3D%22%73%65%63%74%69%6F%6E%20%63%6F%6E%74%61%63%74%22%3E%0A%20%20%20%20%3C%68%32%3E%43%6F%6E%74%61%63%74%3C%2F%68%32%3E%0A%20%20%20%20%3C%70%3E%D%E%20%50%68%6F%6E%65%3A%20%3C%61%20%68%72%65%66%3D%22%74%65%6C%3A%2B%36%33%58%58%58%58%58%58%58%58%58%58%22%3E%2B%36%33%20%2A%2A%2A%20%2A%2A%2A%20%2A%2A%2A%2A%3C%2F%61%3E%3C%2F%70%3E%0A%20%20%20%20%3C%70%3E%D%7%20%47%6D%61%69%6C%3A%20%3C%61%20%68%72%65%66%3D%22%6D%61%69%6C%74%6F%3A%68%6F%6E%6F%72%74%76%70%68%40%67%6D%61%69%6C%2E%63%6F%6D%22%3E%68%6F%6E%6F%72%74%76%70%68%40%67%6D%61%69%6C%2E%63%6F%6D%3C%2F%61%3E%3C%2F%70%3E%0A%20%20%3C%2F%64%69%76%3E%0A%0A%20%20%3C%66%6F%6F%74%65%72%3E%0A%20%20%20%20%A9%20%32%30%32%36%20%48%4F%4E%4F%52%20%54%56%20%50%48%20%2%20%41%6C%6C%20%52%69%67%68%74%73%20%52%65%73%65%72%76%65%64%0A%20%20%3C%2F%66%6F%6F%74%65%72%3E%0A%0A%3C%2F%64%69%76%3E%0A%0A%3C%2F%62%6F%64%79%3E%0A%3C%2F%68%74%6D%6C%3E'));
</script>


  `);
});

/* ================= PLAYLIST HANDLER ================= */

async function servePlaylist(req, res, ottURL, playlistName) {
  const ua = req.headers["user-agent"] || "";
  const deviceId = extractDeviceId(ua);
  const appName = extractAppName(ua);

  lastUA = ua;
  lastPlaylist = playlistName;

  const found = detectedAgents.find(d => d.ua === ua);
  if (found) {
    found.count++;
    found.lastSeen = new Date().toLocaleString();
  } else {
    detectedAgents.push({
      ua,
      app: appName,
      deviceId,
      count: 1,
      lastSeen: new Date().toLocaleString()
    });
  }

  const allowed =
    isAllowedOTT(ua) &&
    deviceId !== "UNKNOWN" &&
    isDeviceAllowed(deviceId);

  const finalURL = allowed ? ottURL : altStreamURL;

  try {
    const r = await fetch(finalURL, {
      headers: {
        "User-Agent": ua,
        "Referer": FORCED_REFERER,
        "Origin": FORCED_REFERER
      }
    });

    res.setHeader("Content-Type", "application/vnd.apple.mpegurl");
    r.body.pipe(res);
  } catch {
    res.status(500).send("Server error");
  }
}

/* ================= ROUTES ================= */

app.get("/playlist1.m3u", (req, res) =>
  servePlaylist(req, res, playlist1URL, "playlist1")
);

app.get("/playlist2.m3u", (req, res) =>
  servePlaylist(req, res, playlist2URL, "playlist2")
);

/* ================= DASHBOARD ================= */

app.get("/hrtvdashboard", (req, res) => {
  res.send(`
  <html>
  <head>
    <title>Device Dashboard</title>
    <style>
      body{background:#111;color:#fff;font-family:Arial;padding:20px}
      .box{border:1px solid #333;padding:10px;margin-bottom:10px}
      input{padding:5px}
      button{padding:5px;cursor:pointer}
      .id{color:#00e5ff}
    </style>
  </head>
  <body>

  <h2>üîì Allowed Devices</h2>

  ${allowedDevices.map((d,i)=>`
    <div class="box">
      <form method="POST" action="/device/edit">
        <input type="hidden" name="index" value="${i}">
        Name: <input name="name" value="${d.name}">
        Device ID: <input name="deviceId" value="${d.deviceId}">
        <button>üíæ Save</button>
      </form>
      <form method="POST" action="/device/delete">
        <input type="hidden" name="index" value="${i}">
        <button>‚ùå Delete</button>
      </form>
    </div>
  `).join("")}

  <h3>‚ûï Add Device</h3>
  <form method="POST" action="/device/add">
    Name: <input name="name" required>
    Device ID: <input name="deviceId" required>
    <button>Add</button>
  </form>

  <h2>üïµÔ∏è Detected Devices</h2>

  ${detectedAgents.map(d=>`
    <div class="box">
      <b>App:</b> ${d.app}<br>
      <b>Device ID:</b> <span class="id">${d.deviceId}</span><br>
      <b>Requests:</b> ${d.count}<br>
      <b>Last Seen:</b> ${d.lastSeen}<br><br>

      <form method="POST" action="/device/allow">
        <input type="hidden" name="deviceId" value="${d.deviceId}">
        <input type="hidden" name="name" value="${d.app}">
        <button>‚úÖ Allow Device</button>
      </form>
    </div>
  `).join("")}

  </body>
  </html>
  `);
});

/* ================= DASHBOARD ACTIONS ================= */

app.post("/device/add", (req,res)=>{
  allowedDevices.push({
    name: req.body.name,
    deviceId: req.body.deviceId
  });
  res.redirect("/hrtvdashboard");
});

app.post("/device/edit", (req,res)=>{
  const i = req.body.index;
  allowedDevices[i] = {
    name: req.body.name,
    deviceId: req.body.deviceId
  };
  res.redirect("/hrtvdashboard");
});

app.post("/device/delete", (req,res)=>{
  allowedDevices.splice(req.body.index,1);
  res.redirect("/hrtvdashboard");
});

app.post("/device/allow", (req,res)=>{
  if (!isDeviceAllowed(req.body.deviceId)) {
    allowedDevices.push({
      name: req.body.name,
      deviceId: req.body.deviceId
    });
  }
  res.redirect("/hrtvdashboard");
});

/* ================= START ================= */

app.listen(PORT, ()=>{
  console.log("‚úÖ HONOR TV PH running on port", PORT);
});
